<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira Escolar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        .main-container {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.ativo { background: #d4edda; color: #155724; }
        .status.trancado { background: #f8d7da; color: #721c24; }
        .status.pendente { background: #fff3cd; color: #856404; }
        .status.inadimplente { background: #f8d7da; color: #721c24; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .search-bar {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .admin-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginContainer" class="login-container">
        <form class="login-form" onsubmit="return handleLogin(event)">
            <h2>Sistema Escolar</h2>
            <div class="form-group">
                <label>Usuário:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>Senha:</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Entrar</button>
        </form>
    </div>

    <!-- Sistema Principal -->
    <div id="mainContainer" class="main-container">
        <div class="header">
            <h1>Sistema de Gestão Financeira Escolar</h1>
            <div>
                <span id="userInfo">Usuário: Admin</span>
                <button class="btn btn-danger" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('alunos')">Alunos</button>
            <button class="tab" onclick="showTab('financeiro')">Financeiro</button>
            <button class="tab" onclick="showTab('rh')">RH</button>
            <button class="tab" onclick="showTab('caixa')">Caixa</button>
            <button class="tab" onclick="showTab('admin')">Admin</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalAlunos">0</h3>
                    <p>Total de Alunos</p>
                </div>
                <div class="stat-card">
                    <h3 id="alunosAtivos">0</h3>
                    <p>Alunos Ativos</p>
                </div>
                <div class="stat-card">
                    <h3 id="alunosTrancados">0</h3>
                    <p>Trancados</p>
                </div>
                <div class="stat-card">
                    <h3 id="alunosPendentes">0</h3>
                    <p>Pendentes</p>
                </div>
                <div class="stat-card">
                    <h3 id="alunosInadimplentes">0</h3>
                    <p>Inadimplentes</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalReceber">R$ 0,00</h3>
                    <p>Total a Receber (Mês)</p>
                </div>
            </div>
        </div>

        <!-- Alunos -->
        <div id="alunos" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gestão de Alunos</h2>
                <button class="btn btn-success" onclick="showModal('modalAluno')">Novo Aluno</button>
            </div>
            
            <input type="text" class="search-bar" placeholder="Pesquisar alunos..." onkeyup="filtrarAlunos(this.value)">
            
            <div class="table-container">
                <table id="tabelaAlunos">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Responsável</th>
                            <th>Status</th>
                            <th>Mensalidade</th>
                            <th>Vencimento</th>
                            <th>Situação Pagamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaAlunos"></tbody>
                </table>
            </div>
        </div>

        <!-- Financeiro -->
        <div id="financeiro" class="tab-content">
            <h2>Gestão Financeira</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="boletosVencidos">0</h3>
                    <p>Boletos Vencidos</p>
                </div>
                <div class="stat-card">
                    <h3 id="boletosHoje">0</h3>
                    <p>Vencem Hoje</p>
                </div>
                <div class="stat-card">
                    <h3 id="pagosCartao">0</h3>
                    <p>Pagos no Cartão</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalMensal">R$ 0,00</h3>
                    <p>Faturamento Mensal</p>
                </div>
            </div>

            <div class="table-container">
                <table id="tabelaFinanceiro">
                    <thead>
                        <tr>
                            <th>Aluno</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Forma Pagamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaFinanceiro"></tbody>
                </table>
            </div>
        </div>

        <!-- RH -->
        <div id="rh" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Recursos Humanos</h2>
                <button class="btn btn-success" onclick="showModal('modalFuncionario')">Novo Funcionário</button>
            </div>
            
            <div class="table-container">
                <table id="tabelaRH">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cargo</th>
                            <th>Salário</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaFuncionarios"></tbody>
                </table>
            </div>
        </div>

        <!-- Caixa -->
        <div id="caixa" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Controle de Caixa</h2>
                <div>
                    <button class="btn btn-success" onclick="showModal('modalEntrada')">Entrada</button>
                    <button class="btn btn-danger" onclick="showModal('modalSaida')">Saída</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalEntradas">R$ 0,00</h3>
                    <p>Total Entradas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSaidas">R$ 0,00</h3>
                    <p>Total Saídas</p>
                </div>
                <div class="stat-card">
                    <h3 id="saldoCaixa">R$ 0,00</h3>
                    <p>Saldo Atual</p>
                </div>
            </div>

            <div class="table-container">
                <table id="tabelaCaixa">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Responsável</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaCaixa"></tbody>
                </table>
            </div>
        </div>

        <!-- Admin -->
        <div id="admin" class="tab-content">
            <h2>Configurações do Sistema</h2>
            
            <div class="admin-section">
                <h3>Integração Google Sheets</h3>
                <div class="form-group">
                    <label>ID da Planilha:</label>
                    <input type="text" id="sheetId" placeholder="Digite o ID da planilha do Google Sheets">
                </div>
                <div class="form-group">
                    <label>URL da Planilha:</label>
                    <input type="text" id="sheetUrl" placeholder="Cole a URL completa da planilha">
                </div>
                <button class="btn btn-success" onclick="vincularPlanilha()">Vincular Planilha</button>
                <button class="btn btn-info" onclick="sincronizarDados()">Sincronizar Dados</button>
            </div>

            <div class="admin-section">
                <h3>Backup e Restauração</h3>
                <button class="btn btn-warning" onclick="exportarDados()">Exportar Dados</button>
                <button class="btn btn-info" onclick="document.getElementById('importFile').click()">Importar Dados</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDados(this)">
            </div>
        </div>
    </div>

    <!-- Modal Aluno -->
    <div id="modalAluno" class="modal">
        <div class="modal-content">
            <h3>Cadastro de Aluno</h3>
            <form onsubmit="return salvarAluno(event)">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Nome do Aluno:</label>
                        <input type="text" id="nomeAluno" required>
                    </div>
                    <div class="form-group">
                        <label>Responsável:</label>
                        <input type="text" id="responsavel">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Responsável Financeiro:</label>
                        <input type="text" id="responsavelFinanceiro">
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="statusAluno" required>
                            <option value="ativo">Ativo</option>
                            <option value="trancado">Trancado</option>
                            <option value="pendente">Pendente</option>
                            <option value="inadimplente">Inadimplente</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Valor Mensalidade:</label>
                        <input type="number" id="valorMensalidade" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Dia Vencimento:</label>
                        <input type="number" id="diaVencimento" min="1" max="31" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Forma de Pagamento:</label>
                    <select id="formaPagamento">
                        <option value="boleto">Boleto</option>
                        <option value="cartao">Cartão</option>
                        <option value="transferencia">Transferência</option>
                        <option value="dinheiro">Dinheiro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contrato:</label>
                    <div class="file-upload" onclick="document.getElementById('contratoFile').click()">
                        <input type="file" id="contratoFile" accept=".pdf,.doc,.docx" onchange="uploadContrato(this)">
                        <p>Clique para fazer upload do contrato</p>
                        <span id="contratoNome"></span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn" onclick="closeModal('modalAluno')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Funcionário -->
    <div id="modalFuncionario" class="modal">
        <div class="modal-content">
            <h3>Cadastro de Funcionário</h3>
            <form onsubmit="return salvarFuncionario(event)">
                <div class="grid-2">
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="nomeFuncionario" required>
                    </div>
                    <div class="form-group">
                        <label>Cargo:</label>
                        <input type="text" id="cargoFuncionario" required>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Salário:</label>
                        <input type="number" id="salarioFuncionario" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="statusFuncionario">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                            <option value="ferias">Férias</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn" onclick="closeModal('modalFuncionario')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Entrada -->
    <div id="modalEntrada" class="modal">
        <div class="modal-content">
            <h3>Registrar Entrada</h3>
            <form onsubmit="return registrarMovimento(event, 'entrada')">
                <div class="form-group">
                    <label>Descrição:</label>
                    <input type="text" id="descricaoEntrada" required>
                </div>
                <div class="form-group">
                    <label>Valor:</label>
                    <input type="number" id="valorEntrada" step="0.01" required>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Registrar</button>
                    <button type="button" class="btn" onclick="closeModal('modalEntrada')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Saída -->
    <div id="modalSaida" class="modal">
        <div class="modal-content">
            <h3>Registrar Saída</h3>
            <form onsubmit="return registrarMovimento(event, 'saida')">
                <div class="form-group">
                    <label>Descrição:</label>
                    <input type="text" id="descricaoSaida" required>
                </div>
                <div class="form-group">
                    <label>Valor:</label>
                    <input type="number" id="valorSaida" step="0.01" required>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-danger">Registrar</button>
                    <button type="button" class="btn" onclick="closeModal('modalSaida')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dados do sistema (simulando banco de dados)
        let dadosEscola = {
            alunos: [],
            funcionarios: [],
            movimentosCaixa: [],
            configuracoes: {
                sheetId: '',
                sheetUrl: ''
            }
        };

        let usuarioAtual = null;

        // Sistema de Login
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Validação simples (em produção, usar autenticação real)
            if (username === 'admin' && password === 'admin123') {
                usuarioAtual = { nome: 'Administrador', permissao: 'admin' };
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = `Usuário: ${usuarioAtual.nome}`;
                carregarDados();
                atualizarDashboard();
            } else if (username === 'funcionario' && password === 'func123') {
                usuarioAtual = { nome: 'Funcionário', permissao: 'funcionario' };
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = `Usuário: ${usuarioAtual.nome}`;
                // Esconder aba admin para funcionários
                document.querySelector('button[onclick="showTab(\'admin\')"]').style.display = 'none';
                carregarDados();
                atualizarDashboard();
            } else {
                alert('Usuário ou senha inválidos!');
            }
            return false;
        }

        function logout() {
            usuarioAtual = null;
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            // Mostrar aba admin novamente
            document.querySelector('button[onclick="showTab(\'admin\')"]').style.display = 'block';
        }

        // Navegação por Abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Atualizar dados da aba
            switch(tabName) {
                case 'dashboard':
                    atualizarDashboard();
                    break;
                case 'alunos':
                    atualizarTabelaAlunos();
                    break;
                case 'financeiro':
                    atualizarTabelaFinanceiro();
                    break;
                case 'rh':
                    atualizarTabelaRH();
                    break;
                case 'caixa':
                    atualizarTabelaCaixa();
                    break;
            }
        }

        // Modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Limpar formulário
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // Fechar modal clicando fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Funções de Alunos
        function salvarAluno(event) {
            event.preventDefault();
            
            const aluno = {
                id: Date.now(),
                nome: document.getElementById('nomeAluno').value,
                responsavel: document.getElementById('responsavel').value,
                responsavelFinanceiro: document.getElementById('responsavelFinanceiro').value,
                status: document.getElementById('statusAluno').value,
                valorMensalidade: parseFloat(document.getElementById('valorMensalidade').value),
                diaVencimento: parseInt(document.getElementById('diaVencimento').value),
                formaPagamento: document.getElementById('formaPagamento').value,
                contrato: document.getElementById('contratoNome').textContent,
                dataCadastro: new Date().toLocaleDateString(),
                situacaoPagamento: 'pendente'
            };

            dadosEscola.alunos.push(aluno);
            salvarDados();
            closeModal('modalAluno');
            atualizarTabelaAlunos();
            atualizarDashboard();
            
            mostrarAlerta('Aluno cadastrado com sucesso!', 'success');
            return false;
        }

        function editarAluno(id) {
            const aluno = dadosEscola.alunos.find(a => a.id === id);
            if (aluno) {
                document.getElementById('nomeAluno').value = aluno.nome;
                document.getElementById('responsavel').value = aluno.responsavel || '';
                document.getElementById('responsavelFinanceiro').value = aluno.responsavelFinanceiro || '';
                document.getElementById('statusAluno').value = aluno.status;
                document.getElementById('valorMensalidade').value = aluno.valorMensalidade;
                document.getElementById('diaVencimento').value = aluno.diaVencimento;
                document.getElementById('formaPagamento').value = aluno.formaPagamento;
                document.getElementById('contratoNome').textContent = aluno.contrato || '';
                
                // Modificar o form para edição
                const form = document.querySelector('#modalAluno form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    aluno.nome = document.getElementById('nomeAluno').value;
                    aluno.responsavel = document.getElementById('responsavel').value;
                    aluno.responsavelFinanceiro = document.getElementById('responsavelFinanceiro').value;
                    aluno.status = document.getElementById('statusAluno').value;
                    aluno.valorMensalidade = parseFloat(document.getElementById('valorMensalidade').value);
                    aluno.diaVencimento = parseInt(document.getElementById('diaVencimento').value);
                    aluno.formaPagamento = document.getElementById('formaPagamento').value;
                    
                    salvarDados();
                    closeModal('modalAluno');
                    atualizarTabelaAlunos();
                    atualizarDashboard();
                    mostrarAlerta('Aluno atualizado com sucesso!', 'success');
                    
                    // Restaurar função original
                    form.onsubmit = salvarAluno;
                    return false;
                };
                
                showModal('modalAluno');
            }
        }

        function excluirAluno(id) {
            if (confirm('Tem certeza que deseja excluir este aluno?')) {
                dadosEscola.alunos = dadosEscola.alunos.filter(a => a.id !== id);
                salvarDados();
                atualizarTabelaAlunos();
                atualizarDashboard();
                mostrarAlerta('Aluno excluído com sucesso!', 'success');
            }
        }

        function mudarStatusAluno(id, novoStatus) {
            const aluno = dadosEscola.alunos.find(a => a.id === id);
            if (aluno) {
                aluno.status = novoStatus;
                salvarDados();
                atualizarTabelaAlunos();
                atualizarDashboard();
                mostrarAlerta(`Status alterado para ${novoStatus}!`, 'success');
            }
        }

        function darBaixaPagamento(id) {
            const aluno = dadosEscola.alunos.find(a => a.id === id);
            if (aluno) {
                aluno.situacaoPagamento = 'pago';
                aluno.dataPagamento = new Date().toLocaleDateString();
                
                // Registrar movimento no caixa
                const movimento = {
                    id: Date.now(),
                    data: new Date().toLocaleDateString(),
                    tipo: 'entrada',
                    descricao: `Mensalidade - ${aluno.nome}`,
                    valor: aluno.valorMensalidade,
                    responsavel: usuarioAtual.nome
                };
                dadosEscola.movimentosCaixa.push(movimento);
                
                salvarDados();
                atualizarTabelaAlunos();
                atualizarTabelaFinanceiro();
                atualizarDashboard();
                mostrarAlerta('Pagamento registrado com sucesso!', 'success');
            }
        }

        function atualizarTabelaAlunos() {
            const tbody = document.getElementById('listaAlunos');
            tbody.innerHTML = '';

            dadosEscola.alunos.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${aluno.nome}</td>
                    <td>${aluno.responsavel || 'N/A'}</td>
                    <td><span class="status ${aluno.status}">${aluno.status.toUpperCase()}</span></td>
                    <td>R$ ${aluno.valorMensalidade.toFixed(2)}</td>
                    <td>Todo dia ${aluno.diaVencimento}</td>
                    <td><span class="status ${aluno.situacaoPagamento}">${aluno.situacaoPagamento.toUpperCase()}</span></td>
                    <td>
                        <button class="btn btn-info" onclick="editarAluno(${aluno.id})">Editar</button>
                        <button class="btn btn-warning" onclick="darBaixaPagamento(${aluno.id})">Dar Baixa</button>
                        <button class="btn btn-danger" onclick="excluirAluno(${aluno.id})">Excluir</button>
                        <select onchange="mudarStatusAluno(${aluno.id}, this.value)" style="margin-top: 5px;">
                            <option value="">Mudar Status</option>
                            <option value="ativo">Ativo</option>
                            <option value="trancado">Trancado</option>
                            <option value="pendente">Pendente</option>
                            <option value="inadimplente">Inadimplente</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filtrarAlunos(termo) {
            const linhas = document.querySelectorAll('#listaAlunos tr');
            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                if (texto.includes(termo.toLowerCase())) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }

        // Funções de Upload
        function uploadContrato(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('contratoNome').textContent = file.name;
                // Em produção, fazer upload para servidor
                mostrarAlerta('Contrato carregado: ' + file.name, 'success');
            }
        }

        // Funções Financeiras
        function atualizarTabelaFinanceiro() {
            const tbody = document.getElementById('listaFinanceiro');
            tbody.innerHTML = '';

            dadosEscola.alunos.forEach(aluno => {
                const hoje = new Date();
                const vencimento = new Date(hoje.getFullYear(), hoje.getMonth(), aluno.diaVencimento);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${aluno.nome}</td>
                    <td>R$ ${aluno.valorMensalidade.toFixed(2)}</td>
                    <td>${vencimento.toLocaleDateString()}</td>
                    <td><span class="status ${aluno.situacaoPagamento}">${aluno.situacaoPagamento.toUpperCase()}</span></td>
                    <td>${aluno.formaPagamento}</td>
                    <td>
                        <button class="btn btn-success" onclick="darBaixaPagamento(${aluno.id})">Pagar</button>
                        <button class="btn btn-warning" onclick="gerarBoleto(${aluno.id})">Gerar Boleto</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Atualizar estatísticas financeiras
            atualizarEstatisticasFinanceiras();
        }

        function gerarBoleto(id) {
            const aluno = dadosEscola.alunos.find(a => a.id === id);
            if (aluno) {
                // Simular geração de boleto
                mostrarAlerta(`Boleto gerado para ${aluno.nome} - Valor: R$ ${aluno.valorMensalidade.toFixed(2)}`, 'success');
            }
        }

        function atualizarEstatisticasFinanceiras() {
            const hoje = new Date();
            let boletosVencidos = 0;
            let boletosHoje = 0;
            let pagosCartao = 0;
            let totalMensal = 0;

            dadosEscola.alunos.forEach(aluno => {
                const vencimento = new Date(hoje.getFullYear(), hoje.getMonth(), aluno.diaVencimento);
                
                if (aluno.situacaoPagamento === 'pendente' && vencimento < hoje) {
                    boletosVencidos++;
                }
                
                if (vencimento.toDateString() === hoje.toDateString()) {
                    boletosHoje++;
                }
                
                if (aluno.formaPagamento === 'cartao' && aluno.situacaoPagamento === 'pago') {
                    pagosCartao++;
                }
                
                if (aluno.situacaoPagamento === 'pago') {
                    totalMensal += aluno.valorMensalidade;
                }
            });

            document.getElementById('boletosVencidos').textContent = boletosVencidos;
            document.getElementById('boletosHoje').textContent = boletosHoje;
            document.getElementById('pagosCartao').textContent = pagosCartao;
            document.getElementById('totalMensal').textContent = `R$ ${totalMensal.toFixed(2)}`;
        }

        // Funções de RH
        function salvarFuncionario(event) {
            event.preventDefault();
            
            const funcionario = {
                id: Date.now(),
                nome: document.getElementById('nomeFuncionario').value,
                cargo: document.getElementById('cargoFuncionario').value,
                salario: parseFloat(document.getElementById('salarioFuncionario').value),
                status: document.getElementById('statusFuncionario').value,
                dataAdmissao: new Date().toLocaleDateString()
            };

            dadosEscola.funcionarios.push(funcionario);
            salvarDados();
            closeModal('modalFuncionario');
            atualizarTabelaRH();
            
            mostrarAlerta('Funcionário cadastrado com sucesso!', 'success');
            return false;
        }

        function editarFuncionario(id) {
            const funcionario = dadosEscola.funcionarios.find(f => f.id === id);
            if (funcionario) {
                document.getElementById('nomeFuncionario').value = funcionario.nome;
                document.getElementById('cargoFuncionario').value = funcionario.cargo;
                document.getElementById('salarioFuncionario').value = funcionario.salario;
                document.getElementById('statusFuncionario').value = funcionario.status;
                
                const form = document.querySelector('#modalFuncionario form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    funcionario.nome = document.getElementById('nomeFuncionario').value;
                    funcionario.cargo = document.getElementById('cargoFuncionario').value;
                    funcionario.salario = parseFloat(document.getElementById('salarioFuncionario').value);
                    funcionario.status = document.getElementById('statusFuncionario').value;
                    
                    salvarDados();
                    closeModal('modalFuncionario');
                    atualizarTabelaRH();
                    mostrarAlerta('Funcionário atualizado com sucesso!', 'success');
                    
                    form.onsubmit = salvarFuncionario;
                    return false;
                };
                
                showModal('modalFuncionario');
            }
        }

        function excluirFuncionario(id) {
            if (confirm('Tem certeza que deseja excluir este funcionário?')) {
                dadosEscola.funcionarios = dadosEscola.funcionarios.filter(f => f.id !== id);
                salvarDados();
                atualizarTabelaRH();
                mostrarAlerta('Funcionário excluído com sucesso!', 'success');
            }
        }

        function atualizarTabelaRH() {
            const tbody = document.getElementById('listaFuncionarios');
            tbody.innerHTML = '';

            dadosEscola.funcionarios.forEach(funcionario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${funcionario.nome}</td>
                    <td>${funcionario.cargo}</td>
                    <td>R$ ${funcionario.salario.toFixed(2)}</td>
                    <td><span class="status ${funcionario.status}">${funcionario.status.toUpperCase()}</span></td>
                    <td>
                        <button class="btn btn-info" onclick="editarFuncionario(${funcionario.id})">Editar</button>
                        <button class="btn btn-danger" onclick="excluirFuncionario(${funcionario.id})">Excluir</button>
                        <button class="btn btn-warning" onclick="gerarFolhaPagamento(${funcionario.id})">Folha</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function gerarFolhaPagamento(id) {
            const funcionario = dadosEscola.funcionarios.find(f => f.id === id);
            if (funcionario) {
                // Simular geração de folha de pagamento
                const salarioLiquido = funcionario.salario * 0.8; // Desconto fictício
                mostrarAlerta(`Folha gerada para ${funcionario.nome} - Salário Líquido: R$ ${salarioLiquido.toFixed(2)}`, 'success');
            }
        }

        // Funções de Caixa
        function registrarMovimento(event, tipo) {
            event.preventDefault();
            
            const descricaoId = tipo === 'entrada' ? 'descricaoEntrada' : 'descricaoSaida';
            const valorId = tipo === 'entrada' ? 'valorEntrada' : 'valorSaida';
            
            const movimento = {
                id: Date.now(),
                data: new Date().toLocaleDateString(),
                tipo: tipo,
                descricao: document.getElementById(descricaoId).value,
                valor: parseFloat(document.getElementById(valorId).value),
                responsavel: usuarioAtual.nome
            };

            dadosEscola.movimentosCaixa.push(movimento);
            salvarDados();
            closeModal(tipo === 'entrada' ? 'modalEntrada' : 'modalSaida');
            atualizarTabelaCaixa();
            
            mostrarAlerta(`${tipo.toUpperCase()} registrada com sucesso!`, 'success');
            return false;
        }

        function excluirMovimento(id) {
            if (confirm('Tem certeza que deseja excluir este movimento?')) {
                dadosEscola.movimentosCaixa = dadosEscola.movimentosCaixa.filter(m => m.id !== id);
                salvarDados();
                atualizarTabelaCaixa();
                mostrarAlerta('Movimento excluído com sucesso!', 'success');
            }
        }

        function atualizarTabelaCaixa() {
            const tbody = document.getElementById('listaCaixa');
            tbody.innerHTML = '';

            // Ordenar por data (mais recentes primeiro)
            const movimentosOrdenados = dadosEscola.movimentosCaixa.sort((a, b) => 
                new Date(b.data.split('/').reverse().join('/')) - new Date(a.data.split('/').reverse().join('/'))
            );

            movimentosOrdenados.forEach(movimento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${movimento.data}</td>
                    <td><span class="status ${movimento.tipo}">${movimento.tipo.toUpperCase()}</span></td>
                    <td>${movimento.descricao}</td>
                    <td style="color: ${movimento.tipo === 'entrada' ? 'green' : 'red'}">
                        ${movimento.tipo === 'entrada' ? '+' : '-'} R$ ${movimento.valor.toFixed(2)}
                    </td>
                    <td>${movimento.responsavel}</td>
                    <td>
                        <button class="btn btn-danger" onclick="excluirMovimento(${movimento.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Atualizar saldos
            atualizarSaldosCaixa();
        }

        function atualizarSaldosCaixa() {
            let totalEntradas = 0;
            let totalSaidas = 0;

            dadosEscola.movimentosCaixa.forEach(movimento => {
                if (movimento.tipo === 'entrada') {
                    totalEntradas += movimento.valor;
                } else {
                    totalSaidas += movimento.valor;
                }
            });

            const saldo = totalEntradas - totalSaidas;

            document.getElementById('totalEntradas').textContent = `R$ ${totalEntradas.toFixed(2)}`;
            document.getElementById('totalSaidas').textContent = `R$ ${totalSaidas.toFixed(2)}`;
            document.getElementById('saldoCaixa').textContent = `R$ ${saldo.toFixed(2)}`;
        }

        // Funções do Dashboard
        function atualizarDashboard() {
            const stats = calcularEstatisticas();
            
            document.getElementById('totalAlunos').textContent = stats.totalAlunos;
            document.getElementById('alunosAtivos').textContent = stats.ativos;
            document.getElementById('alunosTrancados').textContent = stats.trancados;
            document.getElementById('alunosPendentes').textContent = stats.pendentes;
            document.getElementById('alunosInadimplentes').textContent = stats.inadimplentes;
            document.getElementById('totalReceber').textContent = `R$ ${stats.totalReceber.toFixed(2)}`;
        }

        function calcularEstatisticas() {
            const alunos = dadosEscola.alunos;
            
            return {
                totalAlunos: alunos.length,
                ativos: alunos.filter(a => a.status === 'ativo').length,
                trancados: alunos.filter(a => a.status === 'trancado').length,
                pendentes: alunos.filter(a => a.status === 'pendente').length,
                inadimplentes: alunos.filter(a => a.status === 'inadimplente').length,
                totalReceber: alunos
                    .filter(a => a.situacaoPagamento === 'pendente')
                    .reduce((total, a) => total + a.valorMensalidade, 0)
            };
        }

        // Funções de Administração
        function vincularPlanilha() {
            const sheetId = document.getElementById('sheetId').value;
            const sheetUrl = document.getElementById('sheetUrl').value;
            
            if (sheetId && sheetUrl) {
                dadosEscola.configuracoes.sheetId = sheetId;
                dadosEscola.configuracoes.sheetUrl = sheetUrl;
                salvarDados();
                mostrarAlerta('Planilha vinculada com sucesso!', 'success');
            } else {
                mostrarAlerta('Por favor, preencha todos os campos!', 'danger');
            }
        }

        function sincronizarDados() {
            // Simular sincronização com Google Sheets
            if (dadosEscola.configuracoes.sheetId) {
                mostrarAlerta('Sincronização iniciada... (Esta é uma simulação)', 'warning');
                setTimeout(() => {
                    mostrarAlerta('Dados sincronizados com sucesso!', 'success');
                }, 2000);
            } else {
                mostrarAlerta('Nenhuma planilha vinculada!', 'danger');
            }
        }

        function exportarDados() {
            const dados = JSON.stringify(dadosEscola, null, 2);
            const blob = new Blob([dados], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_escola_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarAlerta('Backup exportado com sucesso!', 'success');
        }

        function importarDados(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const dados = JSON.parse(e.target.result);
                        if (confirm('Tem certeza que deseja restaurar estes dados? Isso substituirá todos os dados atuais.')) {
                            dadosEscola = dados;
                            salvarDados();
                            atualizarDashboard();
                            atualizarTabelaAlunos();
                            atualizarTabelaRH();
                            atualizarTabelaCaixa();
                            mostrarAlerta('Dados importados com sucesso!', 'success');
                        }
                    } catch (error) {
                        mostrarAlerta('Erro ao importar dados. Arquivo inválido.', 'danger');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Funções de Persistência
        function salvarDados() {
            try {
                const dadosString = JSON.stringify(dadosEscola);
                const dados = btoa(unescape(encodeURIComponent(dadosString)));
                document.cookie = `escolaData=${dados}; expires=` + new Date(Date.now() + 365*24*60*60*1000).toUTCString() + '; path=/';
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }
        }

        function carregarDados() {
            try {
                const cookies = document.cookie.split(';');
                const escolaCookie = cookies.find(cookie => cookie.trim().startsWith('escolaData='));
                
                if (escolaCookie) {
                    const dados = escolaCookie.split('=')[1];
                    const dadosString = decodeURIComponent(escape(atob(dados)));
                    dadosEscola = JSON.parse(dadosString);
                } else {
                    // Dados de exemplo para demonstração
                    dadosEscola = {
                        alunos: [
                            {
                                id: 1,
                                nome: 'João Silva',
                                responsavel: 'Maria Silva',
                                responsavelFinanceiro: 'Pedro Silva',
                                status: 'ativo',
                                valorMensalidade: 500.00,
                                diaVencimento: 10,
                                formaPagamento: 'boleto',
                                contrato: 'contrato_joao.pdf',
                                dataCadastro: '01/01/2025',
                                situacaoPagamento: 'pago'
                            },
                            {
                                id: 2,
                                nome: 'Ana Costa',
                                responsavel: 'Carlos Costa',
                                responsavelFinanceiro: 'Carlos Costa',
                                status: 'ativo',
                                valorMensalidade: 450.00,
                                diaVencimento: 15,
                                formaPagamento: 'cartao',
                                contrato: '',
                                dataCadastro: '15/01/2025',
                                situacaoPagamento: 'pendente'
                            }
                        ],
                        funcionarios: [
                            {
                                id: 1,
                                nome: 'Prof. Roberto',
                                cargo: 'Professor',
                                salario: 3000.00,
                                status: 'ativo',
                                dataAdmissao: '01/01/2025'
                            }
                        ],
                        movimentosCaixa: [
                            {
                                id: 1,
                                data: '01/09/2025',
                                tipo: 'entrada',
                                descricao: 'Mensalidade - João Silva',
                                valor: 500.00,
                                responsavel: 'Admin'
                            }
                        ],
                        configuracoes: {
                            sheetId: '',
                            sheetUrl: ''
                        }
                    };
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                dadosEscola = { alunos: [], funcionarios: [], movimentosCaixa: [], configuracoes: { sheetId: '', sheetUrl: '' } };
            }
        }

        // Função para mostrar alertas
        function mostrarAlerta(mensagem, tipo) {
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensagem;
            alerta.style.position = 'fixed';
            alerta.style.top = '20px';
            alerta.style.right = '20px';
            alerta.style.zIndex = '9999';
            alerta.style.minWidth = '300px';
            
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                document.body.removeChild(alerta);
            }, 3000);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Sistema já inicializado com dados de exemplo
        });
    </script>
</body>
</html>
